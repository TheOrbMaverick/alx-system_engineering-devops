#!/usr/bin/env bash
# Script to configure Nginx with a custom HTTP response header

# Define variables
NGINX_CONF="/etc/nginx/sites-available/default"
PYTHON_APP_PORT=5000

# Check if Nginx is installed
if ! command -v nginx &> /dev/null; then
    echo "Nginx is not installed. Please install Nginx first." >&2
    exit 1
fi

# Check if the Nginx configuration file exists
if [ ! -f "$NGINX_CONF" ]; then
    echo "Nginx configuration file not found: $NGINX_CONF" >&2
    exit 1
fi

# Check if the Python application is already configured to listen on port 5000
if grep -q "listen $PYTHON_APP_PORT;" "$NGINX_CONF"; then
    echo "Nginx is already configured to forward requests to port $PYTHON_APP_PORT."
    exit 0
fi

# Add reverse proxy configuration to Nginx
cat <<EOF | sudo tee -a "$NGINX_CONF" > /dev/null
server {
    listen 80;
    server_name localhost;

    location / {
        proxy_pass http://127.0.0.1:$PYTHON_APP_PORT;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

# Test Nginx configuration for syntax errors
sudo nginx -t

# Reload Nginx to apply the changes
sudo systemctl reload nginx

echo "Nginx has been configured as a reverse proxy to forward requests from port 80 to port $PYTHON_APP_PORT."